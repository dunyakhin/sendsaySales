<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Excel to JSON Parser</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Парсер Excel в JSON</h1>
  <input type="file" id="fileInput" accept=".xlsx, .xls">
  <pre id="output"></pre>

  <script>
    document.getElementById('fileInput').addEventListener('change', handleFile, false);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        const ordersMap = {};

        rows.forEach(row => {
          const key = row["Номер Заказа"] + "_" + row["EMAIL Покупателя"];
          if (!ordersMap[key]) {
            ordersMap[key] = {
              email: row["EMAIL Покупателя"] || "",
              addr_type: "email",
              transaction_id: row["Номер Заказа"] || "",
              transaction_status: 1,
              transaction_dt: row["Дата и время транзакции"] || "",
              transaction_sum: 0,
              payment_dt: row["Время создания билета"] || "",
              event_type: 1,
              update: 0,
              items: []
            };
          }

          ordersMap[key].items.push({
            id: row["Штрихкод/BARCODE"] || "",
            name: row["Действие"] + " " + row["Действие Дата"],
            price: parseFloat(row["Оплата (руб.)"]) || 0,
            qnt: 1,
            category: row["Канал продажи"] || ""
          });

          ordersMap[key].transaction_sum += parseFloat(row["Оплата (руб.)"]) || 0;
        });

        const result = Object.values(ordersMap);
        document.getElementById('output').textContent = JSON.stringify(result, null, 2);
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
