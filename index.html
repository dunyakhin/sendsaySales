<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Excel to JSON Parser</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Парсер Excel в JSON</h1>
  <input type="file" id="fileInput" accept=".xlsx, .xls">
  <button id="downloadBtn" style="display:none;">Скачать JSON</button>
  <pre id="output"></pre>

  <script>
    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    const outputEl = document.getElementById('output');
    const downloadBtn = document.getElementById('downloadBtn');

    function normalizeKey(key) {
      return key.replace(/\s+/g, ' ').trim().toLowerCase();
    }

    function formatDate(date) {
      if (!date) return "";
      let d = new Date(date);
      if (isNaN(d)) {
        // Попробуем распарсить как строку "08.11.2025 15:30"
        const parts = date.toString().match(/(\d{2})\.(\d{2})\.(\d{4})\s*(\d{2}):(\d{2})/);
        if (parts) {
          d = new Date(parts[3], parts[2]-1, parts[1], parts[4], parts[5]);
        } else return "";
      }
      const pad = n => n.toString().padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        if (!rows.length) {
          outputEl.textContent = "Файл пустой или неправильно распознан";
          return;
        }

        const keyMap = {};
        Object.keys(rows[0]).forEach(k => keyMap[normalizeKey(k)] = k);

        const ordersMap = {};

        rows.forEach(row => {
          const email = row[keyMap["email покупателя"]] || "";
          if (!email) return; // Пропускаем строки с пустым email

          const transaction_id = row[keyMap["номер заказа"]] || "";
          const barcode = row[keyMap["штрихкод/barcode"]] || "";
          const action = row[keyMap["действие"]] || "";
          const date = row[keyMap["дата действия"]] || row[keyMap["действие дата"]] || "";
          const category = row[keyMap["канал продажи"]] || "";
          const payment_dt_raw = row[keyMap["время создания билета"]] || "";
          const price_val = parseFloat(row[keyMap["оплата (руб.)"]]) || 0;

          const payment_dt = formatDate(payment_dt_raw);
          const transaction_dt = payment_dt; // Дублируем payment_dt

          const name = (action + " " + date).trim();
          const price = price_val.toFixed(2);

          const key = transaction_id + "_" + email;
          if (!ordersMap[key]) {
            ordersMap[key] = {
              email: email,
              addr_type: "email",
              transaction_id: transaction_id,
              transaction_status: 1,
              transaction_dt: transaction_dt,
              transaction_sum: 0,
              payment_dt: payment_dt,
              event_type: 1,
              update: 0,
              items: []
            };
          }

          ordersMap[key].items.push({
            id: barcode,
            name: name,
            price: price,
            qnt: 1,
            category: category
          });

          ordersMap[key].transaction_sum += price_val;
        });

        const result = Object.values(ordersMap).map(order => {
          return {
            ...order,
            transaction_sum: order.transaction_sum.toFixed(2)
          };
        });

        // Показать результат
        outputEl.textContent = JSON.stringify(result, null, 2);

        // Кнопка для скачивания JSON
        downloadBtn.style.display = "inline-block";
        downloadBtn.onclick = () => {
          const blob = new Blob([JSON.stringify(result, null, 2)], {type: "application/json"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "orders.json";
          a.click();
          URL.revokeObjectURL(url);
        };
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>

