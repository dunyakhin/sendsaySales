<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Excel → JSON Parser (Large Files Safe)</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    pre { max-height: 400px; overflow: auto; background: #f5f5f5; padding: 10px; }
  </style>
</head>
<body>

<h2>Парсер Excel → JSON</h2>
<input type="file" id="fileInput" accept=".xlsx,.xls">
<button id="downloadBtn" style="display:none;">Скачать JSON</button>

<pre id="output"></pre>

<script>
const outputEl = document.getElementById("output");
const downloadBtn = document.getElementById("downloadBtn");

document.getElementById("fileInput").addEventListener("change", handleFile);

/* ================= HELPERS ================= */

function normalizeKey(key) {
  return key.replace(/\s+/g, " ").trim().toLowerCase();
}

function formatDate(value) {
  if (value === null || value === undefined || value === "") return "";

  const pad = n => String(n).padStart(2, "0");

  // Excel serial date
  if (typeof value === "number") {
    const d = XLSX.SSF.parse_date_code(value);
    return `${d.y}-${pad(d.m)}-${pad(d.d)} ${pad(d.H || 0)}:${pad(d.M || 0)}:${pad(d.S || 0)}`;
  }

  const str = String(value).trim();

  // DD.MM.YYYY HH:mm:ss
  let m = str.match(/^(\d{2})\.(\d{2})\.(\d{4}) (\d{2}):(\d{2}):(\d{2})$/);
  if (m) return `${m[3]}-${m[2]}-${m[1]} ${m[4]}:${m[5]}:${m[6]}`;

  // DD.MM.YYYY HH:mm
  m = str.match(/^(\d{2})\.(\d{2})\.(\d{4}) (\d{2}):(\d{2})$/);
  if (m) return `${m[3]}-${m[2]}-${m[1]} ${m[4]}:${m[5]}:00`;

  // DD.MM.YYYY
  m = str.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if (m) return `${m[3]}-${m[2]}-${m[1]} 00:00:00`;

  // ISO / fallback
  const d = new Date(str);
  if (!isNaN(d)) {
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  return "";
}

/* ================= MAIN ================= */

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  outputEl.textContent = "⏳ Обработка файла...";
  downloadBtn.style.display = "none";

  const reader = new FileReader();
  reader.onload = function(ev) {

    const workbook = XLSX.read(new Uint8Array(ev.target.result), { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    // Заголовки
    const header = XLSX.utils.sheet_to_json(sheet, { header: 1, range: 0 })[0];
    const keyMap = {};
    header.forEach((h, i) => keyMap[normalizeKey(h)] = i);

    // Индексы колонок
    const col = {
      email: keyMap["email покупателя"],
      order: keyMap["номер заказа"],
      barcode: keyMap["штрихкод/barcode"],
      price: keyMap["оплата (руб.)"],
      channel: keyMap["канал продажи"],
      payment: keyMap["время создания билета"],
      action: Object.keys(keyMap).find(k => k.includes("действие")),
      date: Object.keys(keyMap).find(k => k.includes("дата"))
    };

    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, range: 1, defval: "" });
    const orders = {};

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];

      // EMAIL (строго)
      const email = col.email !== undefined ? String(row[col.email]).trim() : "";
      if (!email) continue;

      const orderId = col.order !== undefined ? row[col.order] : "";
      const barcode = col.barcode !== undefined ? row[col.barcode] : "";
      const category = col.channel !== undefined ? row[col.channel] : "";

      // PRICE
      let priceVal = col.price !== undefined
        ? parseFloat(String(row[col.price]).replace(",", "."))
        : 0;
      if (isNaN(priceVal)) priceVal = 0;

      // DATE
      const paymentDt = formatDate(col.payment !== undefined ? row[col.payment] : "");
      if (!paymentDt) continue; // защита
      const transactionDt = paymentDt;

      // NAME
      let action = col.action ? row[keyMap[col.action]] : "";
      let dateVal = col.date ? row[keyMap[col.date]] : "";

      if (typeof dateVal === "number") {
        const d = XLSX.SSF.parse_date_code(dateVal);
        const pad = n => String(n).padStart(2, "0");
        dateVal = `${pad(d.d)}.${pad(d.m)}.${d.y}`;
      }

      const name = `${action} ${dateVal}`.trim();

      const key = `${orderId}_${email}`;

      if (!orders[key]) {
        orders[key] = {
          email,
          addr_type: "email",
          transaction_id: orderId,
          transaction_status: 1,
          transaction_dt: transactionDt,
          transaction_sum: 0,
          payment_dt: paymentDt,
          event_type: 1,
          update: 0,
          items: []
        };
      }

      orders[key].items.push({
        id: barcode,
        name,
        price: priceVal.toFixed(2),
        qnt: 1,
        category
      });

      orders[key].transaction_sum += priceVal;
    }

    const result = Object.values(orders).map(o => ({
      ...o,
      transaction_sum: o.transaction_sum.toFixed(2)
    }));

    outputEl.textContent = JSON.stringify(result, null, 2);

    downloadBtn.style.display = "inline-block";
    downloadBtn.onclick = () => {
      const blob = new Blob([JSON.stringify(result, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "orders.json";
      a.click();
      URL.revokeObjectURL(url);
    };
  };

  reader.readAsArrayBuffer(file);
}
</script>
</body>
</html>
