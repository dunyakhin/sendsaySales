<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Excel ‚Üí Sendsay ORDER</title>
<style>
  body { font-family: Arial; padding: 20px; }
  pre { background:#f5f5f5; padding:10px; max-height:500px; overflow:auto; }
  .log { color:#555; }
  .error { color:red; }
</style>
</head>
<body>

<h2>Excel ‚Üí Sendsay</h2>

<input type="file" id="file" accept=".xlsx,.xls">
<br><br>
<button onclick="processFile()">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª</button>

<h3>–õ–æ–≥</h3>
<pre id="log" class="log"></pre>

<h3>JSON</h3>
<pre id="out"></pre>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
function log(msg) {
  document.getElementById('log').textContent += msg + "\n";
}

function processFile() {
  const input = document.getElementById('file');
  const out = document.getElementById('out');
  out.textContent = "";
  document.getElementById('log').textContent = "";

  if (!input.files.length) {
    log("‚ùå –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω");
    return;
  }

  if (typeof XLSX === "undefined") {
    log("‚ùå XLSX –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (CDN)");
    return;
  }

  log("‚úÖ –§–∞–π–ª –≤—ã–±—Ä–∞–Ω");

  const reader = new FileReader();
  reader.onerror = () => log("‚ùå –û—à–∏–±–∫–∞ FileReader");

  reader.onload = e => {
    try {
      log("üìñ –ß—Ç–µ–Ω–∏–µ Excel");

      const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      log("üìÑ –õ–∏—Å—Ç–æ–≤: " + wb.SheetNames.length);

      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

      log("üìä –°—Ç—Ä–æ–∫: " + rows.length);

      if (rows.length < 2) {
        out.textContent = "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
        return;
      }

      const headers = rows.shift().map(h => h.toString().trim());
      log("üßæ –ó–∞–≥–æ–ª–æ–≤–∫–∏: " + headers.join(" | "));

      const col = name =>
        headers.findIndex(h =>
          h.replace(/\s+/g,'') === name.replace(/\s+/g,'')
        );

      const idx = {
        email: col("EMAIL –ü–æ–∫—É–ø–∞—Ç–µ–ª—è"),
        order: col("–ù–æ–º–µ—Ä –ó–∞–∫–∞–∑–∞"),
        price: col("–û–ø–ª–∞—Ç–∞  (—Ä—É–±.)"),
        seat: col("ID –º–µ—Å—Ç–∞/SEAT_ID"),
        action: col("–î–µ–π—Å—Ç–≤–∏–µ"),
        date: col("–î–∞—Ç–∞"),
        time: col("–í—Ä–µ–º—è")
      };

      log("üîé –ò–Ω–¥–µ–∫—Å—ã: " + JSON.stringify(idx));

      const orders = {};

      rows.forEach(r => {
        if (!r[idx.email] || !r[idx.order]) return;

        if (!orders[r[idx.order]]) {
          orders[r[idx.order]] = {
            email: r[idx.email],
            transaction_id: r[idx.order],
            transaction_dt: formatDT(r[idx.date], r[idx.time]),
            transaction_status: 1,
            transaction_sum: 0,
            items: []
          };
        }

        const price = Number(r[idx.price] || 0);
        orders[r[idx.order]].items.push({
          id: r[idx.seat],
          name: r[idx.action],
          price: price,
          qnt: 1
        });

        orders[r[idx.order]].transaction_sum += price;
      });

      const result = Object.values(orders).map(o => ({
        addr_type: "email",
        addr: o.email,
        event: "ORDER",
        data: o
      }));

      out.textContent = JSON.stringify(result, null, 2);
      log("‚úÖ –ì–æ—Ç–æ–≤–æ. –ó–∞–∫–∞–∑–æ–≤: " + result.length);

    } catch (err) {
      log("‚ùå JS –æ—à–∏–±–∫–∞: " + err.message);
    }
  };

  reader.readAsArrayBuffer(input.files[0]);
}

function formatDT(d, t) {
  if (!d) return "";
  const [dd, mm, yyyy] = d.split(".");
  return `${yyyy}-${mm}-${dd} ${t || "00:00"}:00`;
}
</script>

</body>
</html>
