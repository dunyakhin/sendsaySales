<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Excel ‚Üí Sendsay ORDER</title>
<style>
  body { font-family: Arial; padding: 20px; }
  button { padding: 6px 12px; }
  pre {
    background: #f5f5f5;
    padding: 10px;
    max-height: 400px;
    overflow: auto;
  }
  .log { color:#555; }
  .error { color:red; }
</style>
</head>
<body>

<h2>Excel ‚Üí Sendsay (ORDER)</h2>

<input type="file" id="file" accept=".xlsx,.xls">
<br><br>
<button onclick="processFile()">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª</button>

<h3>–õ–æ–≥</h3>
<pre id="log" class="log"></pre>

<h3>JSON –¥–ª—è Sendsay</h3>
<pre id="out"></pre>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
function log(msg) {
  document.getElementById('log').textContent += msg + "\n";
}

function processFile() {
  const input = document.getElementById('file');
  const out = document.getElementById('out');
  document.getElementById('log').textContent = "";
  out.textContent = "";

  if (!input.files.length) {
    log("‚ùå –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω");
    return;
  }

  if (typeof XLSX === "undefined") {
    log("‚ùå XLSX –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è");
    return;
  }

  log("‚úÖ –§–∞–π–ª –≤—ã–±—Ä–∞–Ω");

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      log("üìÑ –õ–∏—Å—Ç–æ–≤: " + wb.SheetNames.length);

      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

      log("üìä –°—Ç—Ä–æ–∫ –≤—Å–µ–≥–æ: " + rows.length);
      if (rows.length < 2) {
        log("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");
        return;
      }

      // –ó–∞–≥–æ–ª–æ–≤–∫–∏
      const headers = rows.shift().map(h => h.toString().trim());
      log("üßæ –ó–∞–≥–æ–ª–æ–≤–∫–∏: " + headers.join(" | "));

      const col = name =>
        headers.findIndex(h =>
          h.replace(/\s+/g,'') === name.replace(/\s+/g,'')
        );

      const idx = {
        pos: col("‚Ññ –ø–æ–∑–∏—Ü–∏–∏"),
        action: col("–î–µ–π—Å—Ç–≤–∏–µ"),
        date: col("–î–∞—Ç–∞"),
        time: col("–í—Ä–µ–º—è"),
        price: col("–û–ø–ª–∞—Ç–∞  (—Ä—É–±.)"),
        seat: col("ID –º–µ—Å—Ç–∞/SEAT_ID"),
        order: col("–ù–æ–º–µ—Ä –ó–∞–∫–∞–∑–∞"),
        email: col("EMAIL –ü–æ–∫—É–ø–∞—Ç–µ–ª—è")
      };

      log("üîé –ò–Ω–¥–µ–∫—Å—ã: " + JSON.stringify(idx));

      const orders = {};

      rows.forEach((r, i) => {
        if (!r[idx.email] || !r[idx.order]) return;

        if (!orders[r[idx.order]]) {
          orders[r[idx.order]] = {
            email: r[idx.email],
            transaction_id: r[idx.order],
            transaction_dt: formatDT(r[idx.date], r[idx.time]),
            transaction_status: 1,
            transaction_sum: 0,
            items: []
          };
        }

        const price = Number(r[idx.price] || 0);

        orders[r[idx.order]].items.push({
          id: r[idx.seat] || `ticket_${i+1}`,
          name: r[idx.action] || `–ë–∏–ª–µ—Ç ${r[idx.pos] || ""}`,
          price: price,
          qnt: 1
        });

        orders[r[idx.order]].transaction_sum += price;
      });

      const result = Object.values(orders).map(o => ({
        addr_type: "email",
        addr: o.email,
        event: "ORDER",
        data: o
      }));

      out.textContent = JSON.stringify(result, null, 2);
      log("‚úÖ –ì–æ—Ç–æ–≤–æ. –ó–∞–∫–∞–∑–æ–≤: " + result.length);

    } catch (err) {
      log("‚ùå JS –æ—à–∏–±–∫–∞: " + err.message);
    }
  };

  reader.readAsArrayBuffer(input.files[0]);
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Excel-–¥–∞—Ç—ã
function formatDT(d, t) {
  if (!d) return "";

  let dateObj;

  if (d instanceof Date) {
    dateObj = d;
  } else if (typeof d === "number") {
    const parsed = XLSX.SSF.parse_date_code(d);
    if (!parsed) return "";
    dateObj = new Date(parsed.y, parsed.m - 1, parsed.d);
  } else if (typeof d === "string") {
    const p = d.split(".");
    if (p.length !== 3) return "";
    dateObj = new Date(p[2], p[1] - 1, p[0]);
  } else {
    return "";
  }

  const yyyy = dateObj.getFullYear();
  const mm = String(dateObj.getMonth() + 1).padStart(2, "0");
  const dd = String(dateObj.getDate()).padStart(2, "0");
  const time = (typeof t === "string" && t.includes(":")) ? t : "00:00";

  return `${yyyy}-${mm}-${dd} ${time}:00`;
}
</script>

</body>
</html>

