<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Excel ‚Üí Sendsay SSEC</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  button { padding: 6px 14px; }
  pre {
    background: #f5f5f5;
    padding: 10px;
    max-height: 420px;
    overflow: auto;
    white-space: pre-wrap;
  }
  .log { color:#555; }
</style>
</head>
<body>

<h2>Excel ‚Üí Sendsay (SSEC)</h2>

<input type="file" id="file" accept=".xlsx,.xls">
<br><br>
<button onclick="processFile()">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª</button>

<h3>–õ–æ–≥</h3>
<pre id="log" class="log"></pre>

<h3>JSON –¥–ª—è Sendsay</h3>
<pre id="out"></pre>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
function log(msg) {
  document.getElementById('log').textContent += msg + "\n";
}

function processFile() {
  const input = document.getElementById('file');
  const out = document.getElementById('out');
  const logEl = document.getElementById('log');

  logEl.textContent = "";
  out.textContent = "";

  if (!input.files.length) {
    log("‚ùå –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω");
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

      log("üìä –°—Ç—Ä–æ–∫ –≤—Å–µ–≥–æ: " + rows.length);
      if (rows.length < 2) return;

      const headers = rows.shift().map(h => h.toString().trim());
      log("üßæ –ó–∞–≥–æ–ª–æ–≤–∫–∏: " + headers.join(" | "));

      const col = name =>
        headers.findIndex(h =>
          h.replace(/\s+/g,'').toLowerCase() ===
          name.replace(/\s+/g,'').toLowerCase()
        );

      const idx = {
        email: col("EMAIL –ü–æ–∫—É–ø–∞—Ç–µ–ª—è"),
        order: col("–ù–æ–º–µ—Ä –ó–∞–∫–∞–∑–∞"),
        price: col("–û–ø–ª–∞—Ç–∞  (—Ä—É–±.)"),
        seat: col("ID –º–µ—Å—Ç–∞/SEAT_ID"),
        action: col("–î–µ–π—Å—Ç–≤–∏–µ"),
        date: col("–î–∞—Ç–∞"),
        time: col("–í—Ä–µ–º—è")
      };

      log("üîé –ò–Ω–¥–µ–∫—Å—ã: " + JSON.stringify(idx));

      const orders = {};

      rows.forEach((r, i) => {
        const email = r[idx.email];
        const orderId = r[idx.order];
        if (!email || !orderId) return;

        if (!orders[orderId]) {
          orders[orderId] = {
            email: email,
            transaction_id: String(orderId),
            transaction_dt: formatDT(r[idx.date], r[idx.time]),
            transaction_status: 1,
            transaction_sum: 0,
            items: []
          };
        }

        const price = Number(r[idx.price] || 0);

        orders[orderId].items.push({
          id: r[idx.seat] || `ticket_${i+1}`,
          name: r[idx.action] || "–ë–∏–ª–µ—Ç",
          price: price,
          qnt: 1
        });

        orders[orderId].transaction_sum += price;
      });

      // === SSEC —Ñ–æ—Ä–º–∞—Ç —Å event_type = 5 ===
      const result = Object.values(orders).map(o => ({
        addr_type: "email",
        addr: o.email,
        event_type: 5,
        data: {
          transaction_id: o.transaction_id,
          transaction_dt: o.transaction_dt,
          transaction_status: o.transaction_status,
          transaction_sum: o.transaction_sum,
          items: o.items
        }
      }));

      out.textContent = JSON.stringify(result, null, 2);
      log("‚úÖ –ì–æ—Ç–æ–≤–æ. –ó–∞–∫–∞–∑–æ–≤: " + result.length);

    } catch (err) {
      log("‚ùå JS –æ—à–∏–±–∫–∞: " + err.message);
    }
  };

  reader.readAsArrayBuffer(input.files[0]);
}

// === Excel-–¥–∞—Ç–∞ ‚Üí —Å—Ç—Ä–æ–∫–∞ ===
function formatDT(d, t) {
  if (!d) return "";

  let dateObj;

  if (d instanceof Date) {
    dateObj = d;
  } else if (typeof d === "number") {
    const p = XLSX.SSF.parse_date_code(d);
    if (!p) return "";
    dateObj = new Date(p.y, p.m - 1, p.d);
  } else if (typeof d === "string") {
    const parts = d.split(".");
    if (parts.length !== 3) return "";
    dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
  } else {
    return "";
  }

  const yyyy = dateObj.getFullYear();
  const mm = String(dateObj.getMonth() + 1).padStart(2, "0");
  const dd = String(dateObj.getDate()).padStart(2, "0");
  const time = (typeof t === "string" && t.includes(":")) ? t : "00:00";

  return `${yyyy}-${mm}-${dd} ${time}:00`;
}
</script>

</body>
</html>
