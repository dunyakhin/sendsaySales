<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Excel ‚Üí Sendsay JSON (Orders API)</title>
<style>
  body { font-family: Arial; padding: 20px; }
  pre { background: #f5f5f5; padding: 10px; max-height: 400px; overflow: auto; white-space: pre-wrap; }
  .log { color: #555; }
</style>
</head>
<body>

<h2>–ü–∞—Ä—Å–µ—Ä Excel ‚Üí JSON –¥–ª—è Sendsay Orders API</h2>

<input type="file" id="file" accept=".xlsx,.xls">
<button onclick="processFile()">–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å</button>

<h3>–õ–æ–≥</h3>
<pre id="log" class="log"></pre>

<h3>JSON –¥–ª—è Sendsay API</h3>
<pre id="out"></pre>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
function log(msg) {
  document.getElementById("log").textContent += msg + "\n";
}

function processFile() {
  const input = document.getElementById("file");
  const out = document.getElementById("out");
  document.getElementById("log").textContent = "";
  out.textContent = "";

  if (!input.files.length) {
    log("‚ùå –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω");
    return;
  }

  if (typeof XLSX === "undefined") {
    log("‚ùå SheetJS –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    try {
      log("üìñ –ß—Ç–µ–Ω–∏–µ Excel...");
      const wb = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

      log("üìä –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: " + rows.length);
      if (rows.length < 2) {
        log("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");
        return;
      }

      const headers = rows.shift().map(h => h.toString().trim());
      log("üßæ –ó–∞–≥–æ–ª–æ–≤–∫–∏: " + headers.join(" | "));

      const find = name =>
        headers.findIndex(h => h.replace(/\s+/g, "").toLowerCase() === name.replace(/\s+/g, "").toLowerCase());

      const idx = {
        email: find("EMAIL –ü–æ–∫—É–ø–∞—Ç–µ–ª—è"),
        order: find("–ù–æ–º–µ—Ä –ó–∞–∫–∞–∑–∞"),
        price: find("–û–ø–ª–∞—Ç–∞  (—Ä—É–±.)"),
        seat: find("ID –º–µ—Å—Ç–∞/SEAT_ID"),
        action: find("–î–µ–π—Å—Ç–≤–∏–µ"),
        date: find("–î–∞—Ç–∞"),
        time: find("–í—Ä–µ–º—è")
      };

      log("üîé –ò–Ω–¥–µ–∫—Å—ã: " + JSON.stringify(idx));

      const orders = {};

      rows.forEach((r, i) => {
        const email = r[idx.email];
        const orderId = r[idx.order];
        if (!email || !orderId) return;

        if (!orders[orderId]) {
          orders[orderId] = {
            email: email,
            addr_type: "email",
            transaction_id: String(orderId),
            transaction_dt: formatDT(r[idx.date], r[idx.time]),
            transaction_status: 1,
            transaction_sum: 0,
            items: []
          };
        }

        const price = Number(r[idx.price] || 0);

        orders[orderId].items.push({
          id: r[idx.seat] || `ticket_${i+1}`,
          qnt: 1,
          price: price,
          name: r[idx.action] || ""
        });

        orders[orderId].transaction_sum += price;
      });

      const result = Object.values(orders);
      out.textContent = JSON.stringify(result, null, 2);
      log("‚úÖ JSON —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω. –ó–∞–∫–∞–∑–æ–≤: " + result.length);

    } catch (err) {
      log("‚ùå –û—à–∏–±–∫–∞: " + err.message);
    }
  };

  reader.readAsArrayBuffer(input.files[0]);
}

function formatDT(d, t) {
  if (!d) return "";
  let dateObj;

  if (d instanceof Date) {
    dateObj = d;
  } else if (typeof d === "number") {
    const parsed = XLSX.SSF.parse_date_code(d);
    if (!parsed) return "";
    dateObj = new Date(parsed.y, parsed.m - 1, parsed.d);
  } else if (typeof d === "string") {
    const parts = d.split(".");
    if (parts.length === 3) dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
    else return "";
  } else return "";

  const yyyy = dateObj.getFullYear();
  const mm = String(dateObj.getMonth() + 1).padStart(2, "0");
  const dd = String(dateObj.getDate()).padStart(2, "0");

  const time = (typeof t === "string" && t.includes(":")) ? t : "00:00";
  return `${yyyy}-${mm}-${dd} ${time}:00`;
}
</script>

</body>
</html>
