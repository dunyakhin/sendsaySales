<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Excel to JSON Parser (Large Files)</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Парсер Excel → JSON (большие файлы)</h1>

  <input type="file" id="fileInput" accept=".xlsx,.xls">
  <button id="downloadBtn" style="display:none;">Скачать JSON</button>
  <pre id="output"></pre>

<script>
const outputEl = document.getElementById("output");
const downloadBtn = document.getElementById("downloadBtn");

document.getElementById("fileInput").addEventListener("change", handleFile);

function normalizeKey(key) {
  return key.replace(/\s+/g, " ").trim().toLowerCase();
}

function formatDate(date) {
  if (!date && date !== 0) return "";

  // Excel serial date
  if (typeof date === "number") {
    const d = XLSX.SSF.parse_date_code(date);
    const pad = n => String(n).padStart(2, "0");
    return `${d.y}-${pad(d.m)}-${pad(d.d)} ${pad(d.H)}:${pad(d.M)}:${pad(d.S)}`;
  }

  const d = new Date(date);
  if (isNaN(d)) return "";

  const pad = n => String(n).padStart(2, "0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  outputEl.textContent = "⏳ Обработка файла...";
  downloadBtn.style.display = "none";

  const reader = new FileReader();
  reader.onload = function(ev) {
    const data = new Uint8Array(ev.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    // Заголовки
    const header = XLSX.utils.sheet_to_json(sheet, { header: 1, range: 0 })[0];
    const keyMap = {};
    header.forEach((h, i) => keyMap[normalizeKey(h)] = i);

    // Индексы колонок
    const emailCol = keyMap["email покупателя"];
    const orderCol = keyMap["номер заказа"];
    const barcodeCol = keyMap["штрихкод/barcode"];
    const priceCol = keyMap["оплата (руб.)"];
    const channelCol = keyMap["канал продажи"];
    const paymentCol = keyMap["время создания билета"];

    const actionKey = Object.keys(keyMap).find(k => k.includes("действие"));
    const dateKey = Object.keys(keyMap).find(k => k.includes("дата"));

    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, range: 1, defval: "" });

    const orders = {};

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];

      // ===== EMAIL (жёсткая проверка) =====
      let email = emailCol !== undefined ? String(row[emailCol]).trim() : "";
      if (!email) continue; // ❗ полностью исключаем

      const orderId = orderCol !== undefined ? row[orderCol] : "";
      const barcode = barcodeCol !== undefined ? row[barcodeCol] : "";
      const category = channelCol !== undefined ? row[channelCol] : "";

      // Цена
      let priceVal = priceCol !== undefined
        ? parseFloat(String(row[priceCol]).replace(",", "."))
        : 0;
      if (isNaN(priceVal)) priceVal = 0;

      // Дата
      const paymentDt = formatDate(paymentCol !== undefined ? row[paymentCol] : "");
      const transactionDt = paymentDt;

      // NAME = действие + дата
      let action = actionKey ? row[keyMap[actionKey]] : "";
      let dateVal = dateKey ? row[keyMap[dateKey]] : "";

      if (typeof dateVal === "number") {
        const d = XLSX.SSF.parse_date_code(dateVal);
        const pad = n => String(n).padStart(2, "0");
        dateVal = `${pad(d.d)}.${pad(d.m)}.${d.y}`;
      }

      const name = `${action} ${dateVal}`.trim();

      const key = `${orderId}_${email}`;

      if (!orders[key]) {
        orders[key] = {
          email: email,
          addr_type: "email",
          transaction_id: orderId,
          transaction_status: 1,
          transaction_dt: transactionDt,
          transaction_sum: 0,
          payment_dt: paymentDt,
          event_type: 1,
          update: 0,
          items: []
        };
      }

      orders[key].items.push({
        id: barcode,
        name: name,
        price: priceVal.toFixed(2),
        qnt: 1,
        category: category
      });

      orders[key].transaction_sum += priceVal;
    }

    const result = Object.values(orders).map(o => ({
      ...o,
      transaction_sum: o.transaction_sum.toFixed(2)
    }));

    outputEl.textContent = JSON.stringify(result, null, 2);

    downloadBtn.style.display = "inline-block";
    downloadBtn.onclick = () => {
      const blob = new Blob([JSON.stringify(result, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "orders.json";
      a.click();
      URL.revokeObjectURL(url);
    };
  };

  reader.readAsArrayBuffer(file);
}
</script>
</body>
</html>
