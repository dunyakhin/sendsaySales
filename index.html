<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Excel → Sendsay ORDER</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    pre { background: #f5f5f5; padding: 10px; max-height: 500px; overflow: auto; }
  </style>
</head>
<body>

<h2>Загрузите Excel</h2>
<input type="file" id="file" accept=".xlsx,.xls">
<pre id="out"></pre>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
document.getElementById('file').addEventListener('change', e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];

    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
    const headers = rows.shift().map(h => h.toString().trim());

    const col = name =>
      headers.findIndex(h => h.replace(/\s+/g,'') === name.replace(/\s+/g,''));

    const idx = {
      pos: col("№ позиции"),
      action: col("Действие"),
      date: col("Дата"),
      time: col("Время"),
      price: col("Оплата  (руб.)"),
      seatId: col("ID места/SEAT_ID"),
      orderId: col("Номер Заказа"),
      email: col("EMAIL Покупателя")
    };

    const orders = {};

    rows.forEach(r => {
      if (!r[idx.email] || !r[idx.orderId]) return;

      if (!orders[r[idx.orderId]]) {
        orders[r[idx.orderId]] = {
          email: r[idx.email],
          transaction_id: r[idx.orderId],
          transaction_dt: formatDT(r[idx.date], r[idx.time]),
          transaction_status: 1,
          transaction_sum: 0,
          items: []
        };
      }

      const price = Number(r[idx.price] || 0);
      orders[r[idx.orderId]].items.push({
        id: r[idx.seatId],
        name: r[idx.action],
        price: price,
        qnt: 1
      });
      orders[r[idx.orderId]].transaction_sum += price;
    });

    const ssec = Object.values(orders).map(o => ({
      addr_type: "email",
      addr: o.email,
      event: "ORDER",
      data: {
        transaction_id: o.transaction_id,
        transaction_dt: o.transaction_dt,
        transaction_status: o.transaction_status,
        transaction_sum: o.transaction_sum,
        items: o.items
      }
    }));

    document.getElementById('out').textContent =
      JSON.stringify(ssec, null, 2);
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

function formatDT(d, t) {
  if (!d) return "";
  const [dd, mm, yyyy] = d.split(".");
  return `${yyyy}-${mm}-${dd} ${t || "00:00"}:00`;
}
</script>

</body>
</html>
