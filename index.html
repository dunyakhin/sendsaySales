<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Excel → Sendsay JSON Парсер</title>
</head>
<body>
  <h1>Загрузите Excel файл с билетами</h1>
  <input type="file" id="inputExcel" accept=".xlsx, .xls">
  <h2>Результат JSON для Sendsay:</h2>
  <pre id="output"></pre>

  <!-- Подключаем SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    const input = document.getElementById('inputExcel');
    const output = document.getElementById('output');

    input.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        // Преобразуем лист в массив массивов
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        if (rows.length < 2) {
          output.textContent = "Файл пустой или нет данных!";
          return;
        }

        // Чистим заголовки: убираем пробелы и переводим в нижний регистр
        const headers = rows.shift().map(h => h.toString().trim().toLowerCase());

        // Функция для гибкого поиска столбца
        const findHeader = name => headers.findIndex(h => h.includes(name.toLowerCase()));

        const idx = {
          email: findHeader("email"),
          orderId: findHeader("номер заказа"),
          seat: findHeader("id места"),
          ticketNumber: findHeader("№ позиции"),
          price: findHeader("оплата"),
          fio: findHeader("фио"),
          date: findHeader("дата"),
          time: findHeader("время"),
          barcode: findHeader("штрихкод")
        };

        // Проверка: все поля найдены
        for (const key in idx) {
          if (idx[key] === -1) console.warn(`Не найден столбец: ${key}`);
        }

        // Формируем массив продаж для Sendsay
        const sales = [];
        rows.forEach(row => {
          // Пропускаем строки без email или orderId
          if (!row[idx.email] || !row[idx.orderId]) return;

          sales.push({
            email: row[idx.email],
            orderid: row[idx.orderId],
            title: `Билет ${row[idx.ticketNumber]} (место ${row[idx.seat] || row[idx.barcode]})`,
            price: Number(row[idx.price] || 0),
            date: row[idx.date],
            quantity: 1,
            externalid: row[idx.seat] || row[idx.barcode],
            fio: row[idx.fio] || "",
            time: row[idx.time] || ""
          });
        });

        output.textContent = JSON.stringify(sales, null, 2);
      };

      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
